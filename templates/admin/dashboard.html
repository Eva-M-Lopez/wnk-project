{% extends "base.html" %}

{% block title %}Admin Dashboard - Waste Not Kitchen{% endblock %}

{% block content %}
<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    .admin-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .admin-controls {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
    }

    .control-card {
        background: white;
        padding: 15px;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .control-card h3 {
        margin-top: 0;
        font-size: 1.1em;
        border-bottom: 2px solid #eee;
        padding-bottom: 10px;
        margin-bottom: 15px;
        color: #2c3e50;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        background: white;
    }

    .data-table th, .data-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }

    .data-table th {
        background-color: #2c3e50;
        color: white;
    }

    .data-table tr:hover {
        background-color: #f5f5f5;
    }

    .report-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #333;
    }

    .summary-box {
        background: #e8f5e9;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 5px;
        border-left: 5px solid #2e7d32;
    }

    /* Chart Styles */
    .chart-container {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 30px;
        margin-bottom: 40px;
    }
    .chart-box {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .chart-box h3 { margin-top: 0; color: #444; }

    /* Print Styles for Reports */
    @media print {
        /* Added .no-print to the exclusion list */
        nav, footer, .admin-controls, .flash-messages, .btn, .no-print {
            display: none !important;
        }
        .admin-container {
            width: 100%;
            margin: 0;
            padding: 0;
        }
        body {
            background: white;
            font-size: 12pt;
        }
        .data-table th {
            background-color: #ddd !important;
            color: black !important;
            -webkit-print-color-adjust: exact;
        }
    }

    @media (max-width: 900px) {
        .chart-container { grid-template-columns: 1fr; }
    }
</style>

<div class="admin-container">
    <div class="report-header">
        <h2>Admin Dashboard</h2>
        {% if report_type %}
            <button onclick="window.print()" class="btn btn-secondary">Print / Save PDF</button>
        {% else %}
            <a href="{{ url_for('admin.dashboard') }}" class="btn btn-secondary" style="visibility: hidden;">Reset</a>
        {% endif %}
    </div>

    <!-- Admin Controls / Filters -->
    <div class="admin-controls">

        <!-- 1. Member Lookup -->
        <div class="control-card">
            <h3>Member Lookup</h3>
            <form action="{{ url_for('admin.dashboard') }}" method="GET">
                <input type="hidden" name="report_type" value="member_lookup">
                <div class="form-group">
                    <input type="text" name="search_query" placeholder="Email or Name" value="{{ search_query }}" style="width: 100%; padding: 8px; margin-bottom: 10px;">
                </div>
                <button type="submit" class="btn btn-primary">Search Members</button>
            </form>
        </div>

        <!-- 2. Activity & Purchase Reports -->
        <div class="control-card">
            <h3>General Reports</h3>
            <form action="{{ url_for('admin.dashboard') }}" method="GET">
                <div class="form-group">
                    <select name="report_type" style="width: 100%; padding: 8px; margin-bottom: 10px;" required>
                        <option value="" disabled selected>Select Report...</option>
                        <option value="restaurant_activity" {% if report_type == 'restaurant_activity' %}selected{% endif %}>Restaurant Activity</option>
                        <option value="customer_purchases" {% if report_type == 'customer_purchases' %}selected{% endif %}>Customer Purchases</option>
                        <option value="donor_purchases" {% if report_type == 'donor_purchases' %}selected{% endif %}>Donor History</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="start_date" style="font-size: 0.9em;">From Date (Optional):</label>
                    <input type="date" name="start_date" id="start_date" value="{{ start_date }}" style="width: 100%; padding: 8px; margin-bottom: 10px;">
                </div>
                <button type="submit" class="btn btn-primary">Generate</button>
            </form>
        </div>

        <!-- 3. Annual Reports -->
        <div class="control-card">
            <h3>Annual Reports</h3>
            <form action="{{ url_for('admin.dashboard') }}" method="GET">
                <div class="form-group">
                    <select name="report_type" style="width: 100%; padding: 8px; margin-bottom: 10px;" required>
                        <option value="free_plates" {% if report_type == 'free_plates' %}selected{% endif %}>Needy Aid Report</option>
                        <option value="tax_report" {% if report_type == 'tax_report' %}selected{% endif %}>Tax Donation Report</option>
                    </select>
                </div>
                <div class="form-group">
                    <select name="year" style="width: 100%; padding: 8px; margin-bottom: 10px;">
                        {% for y in range(2023, 2026) %}
                            <option value="{{ y }}" {% if year|string == y|string %}selected{% endif %}>{{ y }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Generate Annual Report</button>
            </form>
        </div>
    </div>

    <!-- REPORT RESULTS AREA -->
    {% if report_type %}
        <div class="report-content">
            <!-- Add a Back Button to return to Charts -->
            <!-- ADDED 'no-print' CLASS HERE -->
            <div class="no-print" style="margin-bottom: 15px;">
                <a href="{{ url_for('admin.dashboard') }}">&larr; Back to Overview</a>
            </div>

            <!-- MEMBER LOOKUP RESULTS -->
            {% if report_type == 'member_lookup' %}
                <h3>Member Search Results</h3>
                {% if data %}
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Type</th>
                            <th>Phone</th>
                            <th>Address</th>
                            <th>Joined</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in data %}
                        <tr>
                            <td>{{ user.name }}</td>
                            <td>{{ user.email }}</td>
                            <td>
                                <span style="padding: 2px 6px; border-radius: 4px; background: #eee; font-size: 0.9em;">
                                    {{ user.user_type|capitalize }}
                                </span>
                            </td>
                            <td>{{ user.phone or 'N/A' }}</td>
                            <td>{{ user.address }}</td>
                            <td>{{ user.created_at.strftime('%Y-%m-%d') }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                    <p>No members found matching "{{ search_query }}".</p>
                {% endif %}

            <!-- RESTAURANT ACTIVITY REPORT -->
            {% elif report_type == 'restaurant_activity' %}
                <h3>Restaurant Activity Report</h3>
                <p><em>Activity since: {{ start_date or 'All Time' }}</em></p>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Restaurant Name</th>
                            <th>Listings Created</th>
                            <th>Total Plates Listed</th>
                            <th>Plates Sold/Claimed</th>
                            <th>Efficiency</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in data %}
                        <tr>
                            <td>{{ row.name }}</td>
                            <td>{{ row.listings_count }}</td>
                            <td>{{ row.total_plates }}</td>
                            <td>{{ row.sold_plates }}</td>
                            <td>
                                {% if row.total_plates > 0 %}
                                    {{ "%.1f"|format((row.sold_plates / row.total_plates) * 100) }}%
                                {% else %}
                                    0%
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

            <!-- PURCHASE REPORTS -->
            {% elif report_type == 'customer_purchases' %}
                <h3>Customer Purchase Report</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Customer Name</th>
                            <th>Item Purchased</th>
                            <th>Restaurant</th>
                            <th>Qty</th>
                            <th>Total Paid</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in data %}
                        <tr>
                            <td>{{ row.date.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td>{{ row.user_name }}</td>
                            <td>{{ row.plate_title }}</td>
                            <td>{{ row.restaurant_name }}</td>
                            <td>{{ row.qty }}</td>
                            <td>${{ "%.2f"|format(row.total_price) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

            <!-- DONOR HISTORY -->
            {% elif report_type == 'donor_purchases' %}
                <h3>Donor Contribution History</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Donor Name</th>
                            <th>Item Funded</th>
                            <th>Restaurant</th>
                            <th>Qty</th>
                            <th>Total Donation</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in data %}
                        <tr>
                            <td>{{ row.date.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td>{{ row.donor_name }}</td>
                            <td>{{ row.plate_title }}</td>
                            <td>{{ row.restaurant_name }}</td>
                            <td>{{ row.qty }}</td>
                            <td>${{ "%.2f"|format(row.total_donation) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

            <!-- FREE PLATES ANNUAL REPORT -->
            {% elif report_type == 'free_plates' %}
                <h3>Annual Free Plate Distribution Report ({{ year }})</h3>

                {% if summary %}
                <div class="summary-box">
                    <h3>Summary</h3>
                    <p><strong>Total Plates Distributed:</strong> {{ summary.total_count }}</p>
                    <p><strong>Total Value of Aid Provided:</strong> ${{ "%.2f"|format(summary.total_value or 0) }}</p>
                </div>
                {% endif %}

                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Recipient Name</th>
                            <th>Total Meals Received</th>
                            <th>Last Pickup Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in data %}
                        <tr>
                            <td>{{ row.name }}</td>
                            <td>{{ row.plates_received }}</td>
                            <td>{{ row.last_pickup.strftime('%Y-%m-%d') if row.last_pickup else 'N/A' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

            <!-- TAX DONATION REPORT -->
            {% elif report_type == 'tax_report' %}
                <h3>Annual Donation Tax Report ({{ year }})</h3>
                <p><em>Generated on {{ current_date }} for Tax Year {{ year }}</em></p>
                <div style="background-color: #fff3cd; padding: 10px; border: 1px solid #ffeeba; margin-bottom: 15px;">
                    <strong>Note:</strong> This report includes all confirmed financial transactions flagged as DONATION_PURCHASE.
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Donor Name</th>
                            <th>Donor Email</th>
                            <th>Address (for mailing)</th>
                            <th>Total Contributions</th>
                            <th>Transactions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in data %}
                        <tr>
                            <td>{{ row.name }}</td>
                            <td>{{ row.email }}</td>
                            <td>{{ row.address }}</td>
                            <td><strong>${{ "%.2f"|format(row.total_donated) }}</strong></td>
                            <td>{{ row.transaction_count }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% endif %}

        </div>
    {% else %}
        <!-- CHARTS / OVERVIEW SECTION -->
        <div class="chart-container">
            <!-- Line Chart: Financial Trend -->
            <div class="chart-box">
                <h3>Revenue Trends (Last 30 Days)</h3>
                <canvas id="financialChart"></canvas>
            </div>

            <!-- Pie Chart: User Demographics -->
            <div class="chart-box">
                <h3>User Demographics</h3>
                <canvas id="userChart"></canvas>
            </div>
        </div>

        <script>
            // 1. User Demographics Doughnut Chart
            const userCtx = document.getElementById('userChart').getContext('2d');
            new Chart(userCtx, {
                type: 'doughnut',
                data: {
                    labels: {{ chart_data.user_labels | tojson }},
                    datasets: [{
                        data: {{ chart_data.user_counts | tojson }},
                        backgroundColor: [
                            '#3498db', // Blue
                            '#e74c3c', // Red
                            '#2ecc71', // Green
                            '#f1c40f', // Yellow
                            '#9b59b6'  // Purple
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });

            // 2. Financial Trends Line Chart
            const finCtx = document.getElementById('financialChart').getContext('2d');
            new Chart(finCtx, {
                type: 'line',
                data: {
                    labels: {{ chart_data.dates | tojson }},
                    datasets: [
                        {
                            label: 'Customer Sales ($)',
                            data: {{ chart_data.customer_trend | tojson }},
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Donations ($)',
                            data: {{ chart_data.donor_trend | tojson }},
                            borderColor: '#2ecc71',
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) { return '$' + value; }
                            }
                        }
                    }
                }
            });
        </script>
    {% endif %}
</div>
{% endblock %}